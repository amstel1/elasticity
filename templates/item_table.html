{# item_table.html #}
{#
  EXPECTED CONTEXT DATA STRUCTURE:
  - regions_data: A dictionary where keys are region names (str) and
                  values are lists of item objects (list of dicts).
                  Example: {'Брестский регион': [item1, item2], 'Витебский регион': [item3]}
  - header_columns: A list of strings representing the column names to display,
                    in order. e.g., ['usd__kurs_prinyato', 'usd__kurs_vydano', ...]
  - datetimes: A dictionary with 'voo_calc_datetime' and 'baseline_kurs_calc_datetime'.
#}
<style>
    .usd-group {
        background-color: #e0f7fa; /* Light cyan */
    }
    .eur-group {
        background-color: #fff9c4; /* Light yellow */
    }
    .rub-group {
        background-color: #E9F2F9; /* Light blue/lime */
    }
    table {
        width: 95%;
        border-collapse: collapse;
        margin: 10px auto;
        table-layout: fixed;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 3px;
        text-align: center;
        font-size: 10px;
        vertical-align: middle;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;

    }
    th {
        background-color: #f2f2f2;
        white-space: normal;
        word-break: break-word;
    }
    .negative-cell {
        background-color: #f44336;
        color: white;
        font-weight: bold;
    }
    h2 {
        padding-left: 2.5%;
        margin-bottom: 5px;
        margin-top: 20px;
    }
</style>

<div style="display: flex; flex-direction: column; padding-left: 2.5%; margin-bottom: 10px;">
    {% if datetimes.voo_calc_datetime %}
        <span style="margin: 3px; font-size: 12px;">Фичи обновлены в: {{ datetimes.voo_calc_datetime[:19] }}</span>
    {% endif %}
    {% if datetimes.baseline_kurs_calc_datetime %}
        <span style="margin: 3px; font-size: 12px;">Курсы перекрытия обновлены в: {{ datetimes.baseline_kurs_calc_datetime[:19] }}</span>
    {% endif %}
</div>

{% for region_name, items in regions_data.items() %}
    <h2><strong>{{ region_name }}</strong></h2>
    <table>
        <thead>
            <tr>
                {% for header in header_columns %}
                    {% set currency_class = '' %}
                    {% if header.startswith('USD') %}{% set currency_class = 'usd-group' %}
                    {% elif header.startswith('EUR') %}{% set currency_class = 'eur-group' %}
                    {% elif header.startswith('RUB') %}{% set currency_class = 'rub-group' %}
                    {% endif %}
                    <th class="{{ currency_class }}">{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                {% for header in header_columns %}
                    {% set currency_class = '' %}
                    {% if header.startswith('usd') %}{% set currency_class = 'usd-group' %}
                    {% elif header.startswith('eur') %}{% set currency_class = 'eur-group' %}
                    {% elif header.startswith('rub') %}{% set currency_class = 'rub-group' %}
                    {% endif %}
                    {% set value = item[header] %}
                    <td class="{{ currency_class }}">
                        {# Apply rounding only if the value is a number #}
                        {% if value is number %}
                            {{ value|round(3) }}
                        {% else %}
                            {{ value|default('') }}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}

<script>
    /**
     * Finds all table cells (td), checks if their content is a negative number,
     * and applies a 'negative-cell' class for styling if it is.
     */
    function highlightNegativeCells() {
        const cells = document.querySelectorAll('td');
        cells.forEach(cell => {
            const textContent = cell.textContent.trim();
            // Check if the content is a valid, finite number
            if (textContent && !isNaN(parseFloat(textContent)) && isFinite(textContent)) {
                const value = parseFloat(textContent);
                if (value < 0) {
                    cell.classList.add('negative-cell');
                } else {
                    cell.classList.remove('negative-cell');
                }
            }
        });
    }

    // Run the styling function once the document is fully loaded.
    document.addEventListener('DOMContentLoaded', highlightNegativeCells);
</script>
