{# item_table.html #}

<style>
    /* Currency group background colors */
    .usd-group { background-color: #b2ebf2; } /* Lighter cyan for USD */
    .eur-group { background-color: #fffde7; } /* Lighter yellow for EUR */
    .rub-group { background-color: #e3f2fd; } /* Lighter blue for RUB */

    /* Specific column styling for purchase/sale rates */
    .usd-group-buy-rate { background-color: #80deea; } /* Darker cyan for USD Buy */
    .usd-group-sell-rate { background-color: #4dd0e1; } /* Even darker cyan for USD Sell */
    .eur-group-buy-rate { background-color: #fff59d; } /* Darker yellow for EUR Buy */
    .eur-group-sell-rate { background-color: #ffee58; } /* Even darker yellow for EUR Sell */
    .rub-group-buy-rate { background-color: #90caf9; } /* Darker blue for RUB Buy */
    .rub-group-sell-rate { background-color: #42a5f5; } /* Even darker blue for RUB Sell */

    /* Specific column styling for overlap rates */
    .usd-group-overlap-rate { color: #00796b; } /* Teal for USD Overlap */
    .eur-group-overlap-rate { color: #f57f17; } /* Orange for EUR Overlap */
    .rub-group-overlap-rate { color: #1565c0; } /* Dark blue for RUB Overlap */

    table {
        width: 95%;
        border-collapse: collapse;
        margin: 10px auto;
        table-layout: fixed;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 3px;
        text-align: center;
        font-size: 10px;
        vertical-align: middle;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    th {
        background-color: #f2f2f2;
        white-space: normal;
        word-break: break-word;
    }
    .negative-cell {
        background-color: #f44336;
        color: white;
        font-weight: bold;
    }
    .bold-text {
        font-weight: bold;
    }
    h2 {
        padding-left: 2.5%;
        margin-bottom: 5px;
        margin-top: 20px;
    }
</style>

<div style="display: flex; flex-direction: column; padding-left: 2.5%; margin-bottom: 10px;">
    {% if datetimes.model_calc_dttm %}
        <span style="margin: 3px; font-size: 12px;">Модель рассчитана в: {{ datetimes.model_calc_dttm[:19] }}</span>
    {% endif %}
    {% if datetimes.finrez_dttm %}
        <span style="margin: 3px; font-size: 12px;">Данные алгоритма финреза загружены в: {{ datetimes.model_calc_dttm[:19] }}</span>
    {% endif %}
    {% if datetimes.kurs_perekrutiya_dttm %}
        <span style="margin: 3px; font-size: 12px;">Курсы перекрытия обновлены в: {{ datetimes.kurs_perekrutiya_dttm[:19] }}</span>
    {% endif %}
</div>

{% for region_name, items in regions_data.items() %}
    {% if region_name != 'default_region_name' %}
    <h2><strong>{{ region_name }}</strong></h2>
    {% endif %}
    <table>
        <thead>
            <tr>
                {% for header in header_columns %}
                    {% set currency_class = '' %}
                    {% if header.lower().startswith('usd') %}{% set currency_class = 'usd-group' %}
                    {% elif header.lower().startswith('eur') %}{% set currency_class = 'eur-group' %}
                    {% elif header.lower().startswith('rub') %}{% set currency_class = 'rub-group' %}
                    {% endif %}

                    {% set column_header_class = currency_class %}
                    {% if header.endswith("Курс покупки") %}
                        {% if header.lower().startswith('usd') %}{% set column_header_class = 'usd-group-buy-rate' %}
                        {% elif header.lower().startswith('eur') %}{% set column_header_class = 'eur-group-buy-rate' %}
                        {% elif header.lower().startswith('rub') %}{% set column_header_class = 'rub-group-buy-rate' %}
                        {% endif %}
                    {% elif header.endswith("Курс продажи") %}
                        {% if header.lower().startswith('usd') %}{% set column_header_class = 'usd-group-sell-rate' %}
                        {% elif header.lower().startswith('eur') %}{% set column_header_class = 'eur-group-sell-rate' %}
                        {% elif header.lower().startswith('rub') %}{% set column_header_class = 'rub-group-sell-rate' %}
                        {% endif %}
                    {% endif %}

                    <th class="{{ column_header_class }}">{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                {% for header in header_columns %}
                    {% set currency_class = '' %}
                    {% if header.lower().startswith('usd') %}{% set currency_class = 'usd-group' %}
                    {% elif header.lower().startswith('eur') %}{% set currency_class = 'eur-group' %}
                    {% elif header.lower().startswith('rub') %}{% set currency_class = 'rub-group' %}
                    {% endif %}

                    {% set cell_class = currency_class %}
                    {% if header.endswith("Курс покупки") %}
                        {% if header.lower().startswith('usd') %}{% set cell_class = 'usd-group-buy-rate' %}
                        {% elif header.lower().startswith('eur') %}{% set cell_class = 'eur-group-buy-rate' %}
                        {% elif header.lower().startswith('rub') %}{% set cell_class = 'rub-group-buy-rate' %}
                        {% endif %}
                    {% elif header.endswith("Курс продажи") %}
                        {% if header.lower().startswith('usd') %}{% set cell_class = 'usd-group-sell-rate' %}
                        {% elif header.lower().startswith('eur') %}{% set cell_class = 'eur-group-sell-rate' %}
                        {% elif header.lower().startswith('rub') %}{% set cell_class = 'rub-group-sell-rate' %}
                        {% endif %}
                    {% elif header.endswith("Курс перекрытия") %}
                        {% if header.lower().startswith('usd') %}{% set cell_class = 'usd-group-overlap-rate' %}
                        {% elif header.lower().startswith('eur') %}{% set cell_class = 'eur-group-overlap-rate' %}
                        {% elif header.lower().startswith('rub') %}{% set cell_class = 'rub-group-overlap-rate' %}
                        {% endif %}
                    {% endif %}

                    {% set value = item[header] %}
                    <td class="{{ cell_class }}">
                        {% if value is number %}
                            {% if header == 'Номер точки продаж' %}
                                <strong><a href="/{{ value }}">{{ value }}</a></strong>
                            {% else %}
                                {% set formatted_value = value|round(3) %}
                                {% if header.endswith("Курс покупки") or header.endswith("Курс продажи") or header.endswith("Курс перекрытия") %}
                                    {{ formatted_value }}
                                {% elif header.lower().endswith('доходы') or header.lower().endswith('обороты покупка факт') or header.lower().endswith('обороты продажа факт') %}
                                    <span class="bold-text">{{ formatted_value }}</span>
                                {% else %}
                                    {{ formatted_value }}
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {% if header.lower().endswith('доходы') or header.lower().endswith('обороты покупка факт') or header.lower().endswith('обороты продажа факт') %}
                                <span class="bold-text">{{ value|default('') }}</span>
                            {% else %}
                                {{ value|default('') }}
                            {% endif %}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}
