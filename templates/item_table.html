{# item_table.html #}

<style>
    /* Base currency group colors */
    .usd-group {
        background-color: #e0f7fa; /* Light cyan */
    }
    .eur-group {
        background-color: #fff9c4; /* Light yellow */
    }
    .rub-group {
        background-color: #E9F2F9; /* Light blue */
    }

    /* REQ 1: Override for Buy/Sell columns */
    .usd-group.col-buy    { background-color: #b2ebf2; } /* Darker cyan */
    .usd-group.col-sell   { background-color: #f0fbfc; } /* Lighter cyan */

    .eur-group.col-buy    { background-color: #fff59d; } /* Darker yellow */
    .eur-group.col-sell   { background-color: #fffde7; } /* Lighter yellow */

    .rub-group.col-buy    { background-color: #dcebf6; } /* Darker blue */
    .rub-group.col-sell   { background-color: #f3f8fd; } /* Lighter blue */

    /* REQ 2: Text styling for Overlap columns */
    .col-overlap {
        color: #c2185b; /* Distinctive dark pink/magenta */
        font-weight: 600; /* Make it pop */
    }

    /* REQ 3: Bold text for key financial columns */
    .col-bold {
        font-weight: bold;
    }

    /* Base table styling */
    table {
        width: 95%;
        border-collapse: collapse;
        margin: 10px auto;
        table-layout: fixed;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 3px;
        text-align: center;
        font-size: 10px;
        vertical-align: middle;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    th {
        background-color: #f2f2f2;
        white-space: normal;
        word-break: break-word;
    }
    .negative-cell {
        background-color: #f44336;
        color: white;
        font-weight: bold;
    }
    h2 {
        padding-left: 2.5%;
        margin-bottom: 5px;
        margin-top: 20px;
    }
</style>

<div style="display: flex; flex-direction: column; padding-left: 2.5%; margin-bottom: 10px;">
    {% if datetimes.model_calc_dttm %}
        <span style="margin: 3px; font-size: 12px;">Модель рассчитана в: {{ datetimes.model_calc_dttm[:19] }}</span>
    {% endif %}
    {% if datetimes.finrez_dttm %}
        <span style="margin: 3px; font-size: 12px;">Данные алгоритма финреза загружены в: {{ datetimes.finrez_dttm[:19] }}</span>
    {% endif %}
    {% if datetimes.kurs_perekrutiya_dttm %}
        <span style="margin: 3px; font-size: 12px;">Курсы перекрытия обновлены в: {{ datetimes.kurs_perekrutiya_dttm[:19] }}</span>
    {% endif %}
</div>

{% for region_name, items in regions_data.items() %}
    {% if region_name != 'default_region_name' %}
    <h2><strong>{{ region_name }}</strong></h2>
    {% endif %}
    <table>
        <thead>
            <tr>
                {% for header in header_columns %}
                    {# Refactored: Build a dynamic class list based on header content #}
                    {% set class_list = [] %}
                    {% set header_lower = header.lower() %}

                    {# Base Currency Group #}
                    {% if header_lower.startswith('usd') %}{% set _ = class_list.append('usd-group') %}
                    {% elif header_lower.startswith('eur') %}{% set _ = class_list.append('eur-group') %}
                    {% elif header_lower.startswith('rub') %}{% set _ = class_list.append('rub-group') %}
                    {% endif %}

                    {# REQ 1: Buy/Sell Background #}
                    {% if header.endswith('Курс покупки') %}{% set _ = class_list.append('col-buy') %}
                    {% elif header.endswith('Курс продажи') %}{% set _ = class_list.append('col-sell') %}
                    {% endif %}

                    {# REQ 2: Overlap Text Color #}
                    {% if header.endswith('Курс перекрытия') %}{% set _ = class_list.append('col-overlap') %}
                    {% endif %}

                    {# REQ 3: Bold Financials #}
                    {% if header.endswith('Доходы') or header.endswith('обороты покупка факт') or header.endswith('обороты продажа факт') %}
                        {% set _ = class_list.append('col-bold') %}
                    {% endif %}

                    <th class="{{ class_list|join(' ') }}">{{ header }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                {% for header in header_columns %}
                    {# Refactored: Apply the exact same logic to data cells to ensure alignment #}
                    {% set class_list = [] %}
                    {% set header_lower = header.lower() %}

                    {# Base Currency Group #}
                    {% if header_lower.startswith('usd') %}{% set _ = class_list.append('usd-group') %}
                    {% elif header_lower.startswith('eur') %}{% set _ = class_list.append('eur-group') %}
                    {% elif header_lower.startswith('rub') %}{% set _ = class_list.append('rub-group') %}
                    {% endif %}

                    {# REQ 1: Buy/Sell Background #}
                    {% if header.endswith('Курс покупки') %}{% set _ = class_list.append('col-buy') %}
                    {% elif header.endswith('Курс продажи') %}{% set _ = class_list.append('col-sell') %}
                    {% endif %}

                    {# REQ 2: Overlap Text Color #}
                    {% if header.endswith('Курс перекрытия') %}{% set _ = class_list.append('col-overlap') %}
                    {% endif %}

                    {# REQ 3: Bold Financials #}
                    {% if header.endswith('Доходы') or header.endswith('обороты покупка факт') or header.endswith('обороты продажа факт') %}
                        {% set _ = class_list.append('col-bold') %}
                    {% endif %}

                    {% set value = item[header] %}
                    <td class="{{ class_list|join(' ') }}">
                        {% if value is number %}
                            {% if header == 'Номер точки продаж' %}
                                <strong><a href="/{{ value }}">{{ value }}</a></strong>
                            {% else %}
                                {{ value|round(3) }}
                            {% endif %}
                        {% else %}
                            {{ value|default('') }}
                        {% endif %}
                    </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}
